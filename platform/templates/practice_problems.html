{% extends "base.html" %}

{% block title %}Practice - My Flask Website{% endblock %}

{% block content %}
    <h2 style="margin-bottom: 10px;">Practice Problems</h2>
    <p style="margin-top: 10px; line-height: 1;">
        Below is an AI-generated algebra problem. Please type your answers in the input boxes below. You can add more boxes for additional answers.
    </p>
    {% if message != 'None'%}
    <p style="margin-top: 10px; line-height: 1;">
        {{ message }}
        <br><br>
        <button id="new-problems-button" onclick="generateNewProblems('{{ problem_type }}', '{{ problem_topic }}')">Try Again</button>
        <br>
    </p>

    {% endif %}
    <!-- <h3>{{prob_topic}}</h3>
    <h3>{{prob_type}}</h3>
    <h3>{{problem_topic}}</h3> -->
    <!-- <h3>{{problem_type}}</h3> -->
    {% if problems %}
        <div id="problems-container">
            {% for i in range(problems|length) %}
                <div class="problem" style="display: {% if i == 0 %}block{% else %}none{% endif %};">
                    <h3>Problem {{ i + 1 }}:</h3>
                    <p>Solve \( {{ problems[i] }} \) by <span class="problem-topic">{{ prob_topic }}</span></p>
                    
                    <h4>Your Answer(s):</h4>
                    <h5>Note: each answer should be in the form: <span class="problem-topic">x = ___</span>
                        <br>
                        If there are multiple answers, click "Add Another Answer" below.
                        <br>
                        Please put a space between every variable.
                    </h5>
                    <div id="answer-inputs-{{ i }}">
                        <input type="text" placeholder="Type your answer here" />
                    </div>
                    <button onclick="addAnswerInput({{ i }})">Add Another Answer</button>
                    <button onclick="checkAnswer('{{ solutions[i]|join(', ') }}', {{ i }})">Submit Answers</button>
                    
                    <h4>Solution:
                        <button id="toggle-answer-button-{{ i }}" onclick="toggleAnswer('{{ solutions[i]|join(', ') }}', {{ i }})">Show Answer</button>
                    </h4>
                    
                    <div class="solution" style="display:none;" id="solution-{{ i }}">
                        {% if solutions[i] %}
                            <ul>
                                {% for answer in solutions[i] %}
                                    <li>{{ answer }}</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>No solution found.</p>
                        {% endif %}
                    </div>
                    <br>


                    <div id="result-{{ i }}" style="margin-top: 10px;"></div>

                    {% if i < problems|length - 1 %}
                        <button id="next-button-{{ i }}" onclick="showNextProblem({{ i }})">Next Problem</button>
                    {% else %}
                        <!-- Display new problems button only if there are no more problems -->
                        <button id="new-problems-button" onclick="generateNewProblems('{{ problem_type }}', '{{ problem_topic }}')">Generate New Problems</button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <!-- NEED THIS LINE BELOW IN ORDER TO SHOW ANSWERS!!! -->
    {% else %}
        <p>Sorry, there was an issue generating problems. Please Try Again.</p>
        <button id="new-problems-button" onclick="generateNewProblems('{{ problem_type }}', '{{ problem_topic }}')">Try Again</button>
    {% endif %}




    <script>
        const problemType = "{{ problem_type }}"; // Dynamically injected from Flask
        
        let currentProblemIndex = 0;
        function addAnswerInput(index) {
            const answerInputs = document.getElementById(`answer-inputs-${index}`);
            const newInput = document.createElement('div');
            newInput.innerHTML = `
                <input type="text" placeholder="Type another answer here" />
                <button onclick="removeAnswerInput(this)">Remove</button>
            `;
            answerInputs.appendChild(newInput);
        }

        function removeAnswerInput(button) {
            const answerInputDiv = button.parentElement;
            answerInputDiv.remove();
        }

        function normalizeAnswer(answer) {
            return answer.replace(/\s+/g, '').toLowerCase(); // Remove whitespace and convert to lowercase
        }

        function checkAnswer(correctAnswers, index) {
            const answerInputs = document
                .getElementById(`answer-inputs-${index}`)
                .getElementsByTagName('input');

            // Get user answers
            const userAnswers = Array.from(answerInputs)
                .map(input => input.value.trim()) // Trim whitespace
                .filter(answer => answer !== ''); // Filter out empty answers

            // SIMPLIFY ANSWERS FOR CERTAIN TYPES OF PROBLEMS ONLY (e.g. yes for expressions, no for fractions)
            let processedUserAnswers, processedCorrectAnswers;
            if (problemType === "Simplifying_Expressions") {
                // Use math.simplify for specific problem types
                processedUserAnswers = userAnswers.map(answer => simplifyExpression(answer));
                processedCorrectAnswers = correctAnswers
                    .split(/,(?![^\(]*\))/) // Split by commas outside parentheses
                    .map(answer => simplifyExpression(answer.trim()));
            } else {
                // Use raw answers for other problem types
                processedUserAnswers = userAnswers;
                processedCorrectAnswers = correctAnswers
                    .split(/,(?![^\(]*\))/) // Split by commas outside parentheses
                    .map(answer => answer.trim());
            }

            const resultDiv = document.getElementById(`result-${index}`);

            console.log("User Answers (Processed):", processedUserAnswers); // Debugging statement
            console.log("Correct Answers (Processed):", processedCorrectAnswers); // Debugging statement

            // Check which user answers are correct
            const correctUniqueAnswers = new Set(
                processedUserAnswers.filter(userAnswer => processedCorrectAnswers.includes(userAnswer))
            );

            const providedAnswers = new Set(processedUserAnswers);

            // Debugging statement for correct unique answers
            console.log("Correct Unique Answers:", Array.from(correctUniqueAnswers)); // Debugging statement

            // Generate feedback
            const correctCount = correctUniqueAnswers.size;
            const totalCorrectAnswers = processedCorrectAnswers.length;

            if (userAnswers.length > totalCorrectAnswers) {
                resultDiv.innerHTML = '<p style="color: red;">You provided too many solutions.</p>';
            } else if (correctCount === 0) {
                resultDiv.innerHTML = '<p style="color: red;">No answers were correct.</p>';
            } else if (correctCount < totalCorrectAnswers) {
                resultDiv.innerHTML = `<p style="color: orange;">${correctCount} Correct Answer(s).</p>`;
            } else {
                resultDiv.innerHTML = `<p style="color: green;">Correct! Nice Job.</p>`;
            }

            // Show the correct answer if all unique answers are correct
            if (correctCount === totalCorrectAnswers && userAnswers.length <= totalCorrectAnswers) {
                const solutionDiv = document.getElementById(`solution-${index}`);
                solutionDiv.style.display = 'block';
            }
        }

        // Helper function to simplify an expression and ensure term order doesn't affect equality
        function simplifyExpression(expr) {
            // Simplify the expression using math.simplify
            const simplifiedExpr = math.simplify(expr);

            // Convert the simplified expression to a string, split into terms, sort them, and join back
            const sortedExpr = simplifiedExpr
                .toString()
                .split(' ')
                .sort()
                .join(' ');

            return sortedExpr;
        }






        function showAnswer(correctAnswers, index) {
            const solutionDiv = document.getElementById(`solution-${index}`);
            solutionDiv.style.display = 'block'; // Show correct answers
        }

        function showNextProblem(currentIndex) {
            const problems = document.querySelectorAll('.problem');
            if (currentIndex < problems.length - 1) {
                problems[currentIndex].style.display = 'none'; // Hide current problem
                problems[currentIndex + 1].style.display = 'block'; // Show next problem
            } else {
                alert('You have completed all the problems!');
                document.getElementById(`next-button-${currentIndex}`).style.display = 'none'; // Hide the Next button
            }
        }
        
        function generateNewProblems(problem_type, problem_topic) {
            const url = `/practice_settings`;
            
            // Create a form to submit as a POST request
            const form = document.createElement("form");
            form.method = "POST";
            form.action = url;

            // Add hidden fields for problem_type and problem_topic
            const problemTypeInput = document.createElement("input");
            problemTypeInput.type = "hidden";
            problemTypeInput.name = "problem_type";
            problemTypeInput.value = problem_type;

            const problemTopicInput = document.createElement("input");
            problemTopicInput.type = "hidden";
            problemTopicInput.name = "problem_topic";
            problemTopicInput.value = problem_topic;

            form.appendChild(problemTypeInput);
            form.appendChild(problemTopicInput);

            document.body.appendChild(form);
            form.submit();
        }

        function toggleAnswer(correctAnswers, index) {
            const solutionDiv = document.getElementById(`solution-${index}`);
            const button = document.getElementById(`toggle-answer-button-${index}`);
            
            if (solutionDiv.style.display === 'none') {
                solutionDiv.style.display = 'block'; // Show the answer
                button.innerHTML = 'Hide Answer';    // Change button text to "Hide Answer"
            } else {
                solutionDiv.style.display = 'none';  // Hide the answer
                button.innerHTML = 'Show Answer';    // Change button text back to "Show Answer"
            }
        }





    </script>
{% endblock %}